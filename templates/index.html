<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PhiliNews</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#0d6efd">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding-bottom: 80px; background-color: #f8f9fa; }
        .article-card { transition: all 0.2s; border: 1px solid #e9ecef; border-radius: 12px; overflow: hidden; background: white; margin-bottom: 1rem; }
        .article-card.selected { border-color: #0d6efd; background-color: #f0f7ff; }
        .article-img { height: 160px; object-fit: cover; width: 100%; background-color: #eee; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 1050; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .bottom-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: white; padding: 15px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 1000; display: flex; gap: 10px; justify-content: space-around; }
        .hidden { display: none !important; }
        .install-prompt { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; width: 90%; max-width: 400px; }
    </style>
</head>
<body>

    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="#">PhiliNews ðŸ‡µðŸ‡­</a>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">

        <!-- Search Section -->
        <div class="card shadow-sm mb-4 border-0">
            <div class="card-body">
                <h5 class="card-title mb-3">Find Today's News</h5>
                <div class="input-group mb-3">
                    <input type="text" id="keyword" class="form-control form-control-lg" placeholder="Enter keyword (e.g. Traffic)">
                </div>
                <button class="btn btn-primary btn-lg w-100" onclick="searchNews()">Search News</button>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsArea" class="hidden">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">Found <span id="resultCount">0</span> Articles</h5>
                <button class="btn btn-outline-secondary btn-sm" onclick="toggleSelectAll()">Select All</button>
            </div>
            <div id="articlesList">
                <!-- Articles will be injected here -->
            </div>
        </div>
    </div>

    <!-- Bottom Actions -->
    <div id="bottomBar" class="bottom-bar hidden">
        <button class="btn btn-danger flex-grow-1" onclick="exportReport('pdf')">
            <i class="bi bi-file-pdf"></i> Save as PDF
        </button>
        <button class="btn btn-warning flex-grow-1 text-white" onclick="exportReport('pptx')">
            <i class="bi bi-file-ppt"></i> Save as PPT
        </button>
    </div>

    <!-- Loading Overlay -->
    <div id="loader" class="loading-overlay hidden">
        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
        <p class="mt-3 fw-bold text-secondary" id="loadingText">Processing...</p>
    </div>

    <!-- Install Prompt (PWA) -->
    <div id="installPrompt" class="alert alert-info alert-dismissible fade show hidden install-prompt" role="alert">
        <strong>Install App:</strong> Add to Home Screen for quick access.
        <button type="button" class="btn btn-sm btn-primary ms-2" onclick="installPWA()">Install</button>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentArticles = [];
        let selectedIndices = new Set();
        let deferredPrompt;

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(reg => console.log('SW registered!', reg))
                .catch(err => console.log('SW registration failed', err));
        }

        // PWA Install Prompt
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installPrompt').classList.remove('hidden');
        });

        async function installPWA() {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            deferredPrompt = null;
            document.getElementById('installPrompt').classList.add('hidden');
        }

        async function searchNews() {
            const keyword = document.getElementById('keyword').value;
            if (!keyword) return alert("Please enter a keyword");

            // Default to a high number as requested
            const numResults = 20;

            showLoader(true, "Searching & Scraping... This may take a minute.");
            document.getElementById('resultsArea').classList.add('hidden');
            document.getElementById('bottomBar').classList.add('hidden');

            try {
                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keyword, num_results: numResults })
                });

                const data = await response.json();

                if (data.error) throw new Error(data.error);

                currentArticles = data.results;

                if (currentArticles.length === 0) {
                     alert("No articles found using Search Engines or RSS Feeds. Please try a different keyword or check back later.");
                }

                renderArticles();
                document.getElementById('resultsArea').classList.remove('hidden');

                if (currentArticles.length > 0) {
                    document.getElementById('bottomBar').classList.remove('hidden');
                } else {
                    document.getElementById('bottomBar').classList.add('hidden');
                }

            } catch (error) {
                alert("Error: " + error.message);
            } finally {
                showLoader(false);
            }
        }

        function renderArticles() {
            const container = document.getElementById('articlesList');
            container.innerHTML = '';
            selectedIndices.clear();
            document.getElementById('resultCount').innerText = currentArticles.length;

            currentArticles.forEach((article, index) => {
                selectedIndices.add(index); // Select all by default

                const div = document.createElement('div');
                div.className = 'article-card selected';
                div.onclick = (e) => toggleSelection(index, div);

                const imgSrc = article.top_image && article.top_image.startsWith('http')
                    ? article.top_image
                    : 'https://via.placeholder.com/400x200?text=No+Image';

                div.innerHTML = `
                    <div class="row g-0">
                        <div class="col-4">
                            <img src="${imgSrc}" class="article-img" alt="News Image">
                        </div>
                        <div class="col-8">
                            <div class="card-body py-2 px-3">
                                <h6 class="card-title fw-bold mb-1 text-truncate">${article.title || 'No Title'}</h6>
                                <p class="card-text text-muted small mb-1">${article.publish_date || 'Date Unknown'}</p>
                                <p class="card-text small text-truncate" style="max-height: 40px; overflow: hidden;">${article.summary || ''}</p>
                                <div class="form-check mt-1">
                                    <input class="form-check-input" type="checkbox" checked id="check_${index}" style="pointer-events: none;">
                                    <label class="form-check-label small text-primary">Selected</label>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function toggleSelection(index, cardElement) {
            const checkbox = cardElement.querySelector('.form-check-input');
            if (selectedIndices.has(index)) {
                selectedIndices.delete(index);
                cardElement.classList.remove('selected');
                checkbox.checked = false;
            } else {
                selectedIndices.add(index);
                cardElement.classList.add('selected');
                checkbox.checked = true;
            }
        }

        function toggleSelectAll() {
            // Logic to toggle all
            const allSelected = selectedIndices.size === currentArticles.length;
            const cards = document.querySelectorAll('.article-card');

            cards.forEach((card, index) => {
                const checkbox = card.querySelector('.form-check-input');
                if (allSelected) {
                    selectedIndices.delete(index);
                    card.classList.remove('selected');
                    checkbox.checked = false;
                } else {
                    selectedIndices.add(index);
                    card.classList.add('selected');
                    checkbox.checked = true;
                }
            });
        }

        async function exportReport(format) {
            if (selectedIndices.size === 0) return alert("Please select at least one article.");

            showLoader(true, `Generating ${format.toUpperCase()}...`);

            const keyword = document.getElementById('keyword').value;
            const selectedArticles = currentArticles.filter((_, i) => selectedIndices.has(i));

            try {
                const response = await fetch('/api/export', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        articles: selectedArticles,
                        format: format,
                        keyword: keyword
                    })
                });

                const data = await response.json();
                if (data.error) throw new Error(data.error);

                // Trigger download
                window.location.href = data.download_url;

            } catch (error) {
                alert("Export Failed: " + error.message);
            } finally {
                showLoader(false);
            }
        }

        function showLoader(show, text="Processing...") {
            const loader = document.getElementById('loader');
            const txt = document.getElementById('loadingText');
            if (show) {
                txt.innerText = text;
                loader.classList.remove('hidden');
            } else {
                loader.classList.add('hidden');
            }
        }
    </script>
</body>
</html>
